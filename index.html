<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Module Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .course-card {
        transition: all 0.3s ease;
      }
      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      /* Modal styles */
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .theme-toggle svg {
        transition: transform 0.3s ease;
      }
      .theme-toggle.collapsed svg {
        transform: rotate(-90deg);
      }
      /* Timetable styles */
      #timetable-grid {
        display: grid;
        grid-template-columns: 60px repeat(5, 1fr);
        grid-template-rows: 40px repeat(12, 60px); /* 8am to 8pm */
      }
      .time-slot {
        grid-column: 1 / 2;
      }
      .day-header {
        grid-row: 1 / 2;
      }
      .timetable-event {
        position: absolute;
        z-index: 10;
        transition: all 0.2s ease;
      }
      .timetable-event.clash {
        border: 2px solid #ef4444 !important;
        background-color: rgba(239, 68, 68, 0.2) !important;
        z-index: 20;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">Module Selector</h1>
        <p class="text-lg text-gray-600 mt-2">
          Select module offerings to build your timetable.
        </p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Modules List -->
        <div class="lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-900">
              Available Modules
            </h2>
            <button
              id="add-custom-course-btn"
              class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75"
            >
              Add Custom Module
            </button>
          </div>
          <!-- Search Bar -->
          <div class="mb-6">
            <input
              type="text"
              id="search-bar"
              placeholder="Search by module name or code..."
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div id="course-list" class="space-y-4">
            <!-- Themed module sections will be injected here by JavaScript -->
          </div>
        </div>

        <!-- Sidebar -->
        <div>
          <div class="sticky top-8 space-y-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                Timetables
              </h2>
              <div class="space-y-4">
                <div>
                  <label
                    for="timetable-switcher"
                    class="block text-sm font-medium text-gray-700"
                    >Current Timetable</label
                  >
                  <select
                    id="timetable-switcher"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  ></select>
                </div>
                <div class="flex space-x-2">
                  <input
                    type="text"
                    id="new-timetable-name"
                    placeholder="New timetable name..."
                    class="flex-grow p-2 border border-gray-300 rounded-md"
                  />
                  <button
                    id="add-timetable-btn"
                    class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700"
                  >
                    +
                  </button>
                </div>
                <button
                  id="delete-timetable-btn"
                  class="w-full text-sm text-red-600 hover:text-red-800 font-semibold p-2 rounded-md border border-red-200 hover:bg-red-50"
                >
                  Delete Current Timetable
                </button>
              </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-900">
                  Selection Summary
                </h2>
                <button
                  id="clear-all-btn"
                  class="text-sm text-red-600 hover:text-red-800 font-semibold"
                >
                  Clear All
                </button>
              </div>
              <div id="selection-summary" class="space-y-2">
                <p class="text-lg">
                  Total Credits:
                  <span id="total-credits" class="font-bold text-indigo-600"
                    >0</span
                  >
                </p>
                <div id="selected-courses-summary-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timetable Section -->
      <div
        id="timetable-container"
        class="bg-white p-4 rounded-lg shadow-md mt-12"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-900 text-center">
          Weekly Timetable
        </h2>
        <div
          id="clash-warning"
          class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"
        >
          <span class="font-bold">Warning:</span> You have timetable clashes.
          Clashing slots are highlighted in red.
        </div>
        <div class="relative">
          <div id="timetable-grid" class="relative bg-white">
            <!-- Grid lines and headers will be generated here -->
          </div>
          <div
            id="timetable-events"
            class="absolute top-0 left-0 w-full h-full"
          >
            <!-- Events will be placed here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Timings Modal -->
    <div
      id="timing-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"
      >
        <div class="mt-3 text-center">
          <h3
            class="text-lg leading-6 font-medium text-gray-900"
            id="timing-modal-title"
          >
            Add New Timing
          </h3>
          <div class="mt-2 px-7 py-3">
            <form id="timing-form">
              <input type="hidden" id="course-code-input" />
              <div class="mb-4 text-left">
                <label
                  for="offering-type"
                  class="block text-sm font-medium text-gray-700"
                  >Type</label
                >
                <input
                  type="text"
                  id="offering-type"
                  placeholder="e.g., Lecture, Practical"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
              <div class="mb-4 text-left">
                <label
                  for="offering-day"
                  class="block text-sm font-medium text-gray-700"
                  >Day</label
                >
                <select
                  id="offering-day"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                >
                  <option>Mon</option>
                  <option>Tues</option>
                  <option>Wed</option>
                  <option>Thurs</option>
                  <option>Fri</option>
                </select>
              </div>
              <div class="mb-4 text-left">
                <label
                  for="start-time"
                  class="block text-sm font-medium text-gray-700"
                  >Start Time</label
                >
                <input
                  type="time"
                  id="start-time"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
              <div class="mb-4 text-left">
                <label
                  for="end-time"
                  class="block text-sm font-medium text-gray-700"
                  >End Time</label
                >
                <input
                  type="time"
                  id="end-time"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
            </form>
          </div>
          <div class="items-center px-4 py-3">
            <button
              id="save-timing-btn"
              class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300"
            >
              Save
            </button>
            <button
              id="close-timing-modal-btn"
              class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Custom Module Modal -->
    <div
      id="custom-course-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay"
    >
      <div
        class="relative top-5 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white"
      >
        <div class="mt-3 text-center">
          <h3
            class="text-lg leading-6 font-medium text-gray-900"
            id="custom-course-modal-title"
          >
            Add Custom Module
          </h3>
          <form id="custom-course-form" class="mt-4 space-y-4 text-left">
            <input type="hidden" id="editing-course-code" />
            <div>
              <label
                for="custom-course-name"
                class="block text-sm font-medium text-gray-700"
                >Module Name</label
              >
              <input
                type="text"
                id="custom-course-name"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required
              />
            </div>
            <div>
              <label
                for="custom-course-code"
                class="block text-sm font-medium text-gray-700"
                >Module Code</label
              >
              <input
                type="text"
                id="custom-course-code"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required
              />
            </div>
            <div>
              <label
                for="custom-course-credits"
                class="block text-sm font-medium text-gray-700"
                >Credits</label
              >
              <input
                type="number"
                id="custom-course-credits"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required
              />
            </div>
            <div>
              <label
                for="custom-course-semester"
                class="block text-sm font-medium text-gray-700"
                >Semester</label
              >
              <input
                type="text"
                id="custom-course-semester"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required
              />
            </div>
            <div id="custom-timings-container">
              <!-- Timing fields will be added here -->
            </div>
            <button
              type="button"
              id="add-another-timing-btn"
              class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold"
            >
              + Add another timing
            </button>
          </form>
          <div class="items-center px-4 py-3 mt-4">
            <button
              id="save-custom-course-btn"
              class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300"
            >
              Save Module
            </button>
            <button
              id="close-custom-course-modal-btn"
              class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Default module data.
      const courseDataString = `
        [
            {
                "theme": "Artificial Intelligence and Cognitive Science",
                "courses": [
                    { "name": "Human Computer Interaction (COMP30960)", "semester": 1, "credits": 5, "timings": "Practical Offering 1: Fri 13:00-13:50, Lecture: Mon 16:00-16:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Introduction to Cognitive Psychology (COMP40250)", "semester": 1, "credits": 7.5, "timings": "Lecture: Wed 11:00-12:50" },
                    { "name": "Multi-Agent Systems (COMP41400)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 16:00-17:50, Practical: Wed 15:00-16:50" },
                    { "name": "Human-Centred Artificial Intelligence (COMP41740)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Artificial/Human Intelligence (COMP41760)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 11:00-11:50, Practical: Thurs 12:00-12:50" },
                    { "name": "Introduction to Cognitive Science (Graduate) (COMP47230)", "semester": 1, "credits": 7.5, "timings": "Lecture: Mon 11:00-12:50" },
                    { "name": "Connectionism and Dynamical Systems (COMP40260)", "semester": 2, "credits": 7.5, "timings": "Lecture: Mon 11:00-12:50, Practical: Mon 14:00-15:50" },
                    { "name": "Speech and Audio (COMP47700)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 14:00-15:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Generative AI: Language Models (COMP47980)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 16:00-16:50, Practical: Thurs 10:00-11:50, Lecture: Thurs 16:00-16:50" },
                    { "name": "Artificial Intelligence & Ethics (IS40970)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 13:00-14:50" }
                ]
            },
            {
                "theme": "Computer Engineering",
                "courses": [
                    { "name": "Wireless Systems (EEEN40050)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 12:00-12:50, Lecture: Tues 09:00-09:50, Lecture: Wed 14:00-14:50, Laboratory Offering 1: Fri 15:00-16:50, Laboratory Offering 2: Wed 15:00-16:50" },
                    { "name": "Digital Communications (EEEN40060)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 09:00-09:50, Lecture: Thurs 11:00-11:50, Lecture: Thurs 16:00-16:50, Tutorial: Thurs 16:00-17:50, Lecture: Wed 13:00-13:50" },
                    { "name": "Quantitative Methods for Engineers (STAT40690)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 15:00-16:50" },
                    { "name": "Performance of Computer Systems (COMP40010)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Advances in Wireless Networking (COMP40660)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 11:00-12:50, Practical: Mon 13:00-14:50" },
                    { "name": "Digital & Embedded Systems (EEEN40280)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Tutorial: Tues 11:00-12:50, Lecture: Wed 11:00-11:50, Lecture: Wed 13:00-13:50, Laboratory: Thurs 13:00-14:50" }
                ]
            },
            {
                "theme": "Computers and Society",
                "courses": [
                    { "name": "Enterprise, Innovation & Entrepreneurship (COMP30390)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 13:00-13:50, Lecture: Tues 13:00-13:50, Practical: Wed 11:00-12:50" },
                    { "name": "Social Simulation: Methods and Models (SOC40640)", "semester": 1, "credits": 10, "timings": "Lecture: Mon 09:00-09:50, Lecture: Wed 09:00-09:50" },
                    { "name": "Enviro-Tech Boot Camp (COMP30840)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 16:00-16:50, Tutorial: Thurs 13:00-13:50, Lecture: Wed 13:00-13:50" },
                    { "name": "Ethical Hacking (COMP47860)", "semester": 2, "credits": 5, "timings": "Practical Offering 1: Fri 14:00-15:50, Practical Offering 2: Mon 15:00-16:50" },
                    { "name": "Digital Media Ethics (IS30370)", "semester": 2, "credits": 5, "timings": "Lecture: Wed 12:00-13:50" },
                    { "name": "Digital Storytelling (IS30380)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-11:50" },
                    { "name": "Digital Libraries (IS40560)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 16:00-17:50" },
                    { "name": "Social Networks Online and Off (IS41510)", "semester": 2, "credits": 10, "timings": "Lecture: Mon 10:00-11:50" }
                ]
            },
            {
                "theme": "Data Manipulation and Visualisation",
                "courses": [
                    { "name": "Information Visualisation (COMP40610)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 09:00-10:50, Practical Offering 1: Mon 11:00-12:50, Practical Offering 2: Fri 09:00-10:50" },
                    { "name": "Augmented and Virtual Reality (COMP47930)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 13:00-14:50, Practical: Thurs 09:00-10:50" },
                    { "name": "GIS Principles and Applications (GEOG40820)", "semester": 1, "credits": 10, "timings": "Lecture: Wed 15:00-16:50" },
                    { "name": "Spatial Information Systems (COMP30110)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-15:50, Lecture: Thurs 16:00-16:50" },
                    { "name": "Introduction to Relational Databases and SQL Programming (COMP40725)", "semester": 2, "credits": 10, "timings": "Lecture: Fri 09:00-10:50, Practical: Fri 11:00-12:50" },
                    { "name": "Information Visualisation (blended delivery) (COMP47970)", "semester": 2, "credits": 5, "timings": "Laboratory: Fri 14:00-15:50" }
                ]
            },
            {
                "theme": "Prediction and Learning with Data",
                "courses": [
                    { "name": "Data Mining (COMP40370)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 11:00-11:50, Lecture: Tues 13:00-13:50, Practical Offering 1: Tues 16:00-17:50, Practical Offering 2: Wed 13:00-14:50" },
                    { "name": "Connectionist Computing (COMP41390)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Text Analytics (COMP41730)", "semester": 1, "credits": 5, "timings": "Lecture: Wed 10:00-10:50" },
                    { "name": "Machine Learning (COMP47460)", "semester": 1, "credits": 5, "timings": "Tutorial: Fri 13:00-14:50" },
                    { "name": "Machine Learning w/ Python (COMP47750)", "semester": "1, 2", "credits": 5, "timings": "Lecture: Thurs 10:00-10:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Optimisation (COMP47790)", "semester": 1, "credits": 5, "timings": "Tutorial: Thurs 14:00-15:50" },
                    { "name": "Intro. to Quantum Computing (EEEN40680)", "semester": 1, "credits": 5, "timings": "Tutorial: Wed 15:00-16:50" },
                    { "name": "Recommender Systems & Collective Intelligence (COMP31010)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 17:00-18:50, Lecture: Wed 14:00-15:50" },
                    { "name": "Advanced Machine Learning (COMP47590)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 12:00-13:50, Laboratory: Tues 15:00-15:50" },
                    { "name": "Deep Learning (COMP47650)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 09:00-10:50, Tutorial: Wed 13:00-13:50" },
                    { "name": "Quantum Machine Learning (COMP47950)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 09:00-10:50" },
                    { "name": "Machine Learning w/ Python (online) (COMP47990)", "semester": 2, "credits": 5, "timings": "Tutorial: Tues 17:00-17:50" },
                    { "name": "Statistical Machine Learning (STAT30270)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 15:00-15:50, Tutorial Offering 1: Thurs 17:00-17:50, Tutorial Offering 2: Wed 17:00-17:50, Tutorial Offering 3: Tues 17:00-17:50" }
                ]
            },
            {
                "theme": "Data Science Programming",
                "courses": [
                    { "name": "Data Programming with R (STAT30340)", "semester": 1, "credits": 5, "timings": "Laboratory Offering 1: Thurs 09:00-09:50, Laboratory Offering 2: Thurs 11:00-11:50, Laboratory Offering 3: Mon 09:00-09:50" },
                    { "name": "Data Science in Python (COMP41680)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 09:00-09:50, Lecture: Wed 09:00-09:50" },
                    { "name": "Big Data Programming (COMP47470)", "semester": "1, 2", "credits": 5, "timings": "Practical: Fri 09:00-10:50, Lecture: Tues 09:00-10:50, Practical: Fri 14:00-15:50, Lecture: Tues 11:00-12:50" },
                    { "name": "Data Science in Python (COMP47670)", "semester": "1, 2", "credits": 5, "timings": "Practical: Mon 16:00-16:50, Practical: Mon 17:00-17:50" }
                ]
            },
            {
                "theme": "Distributed Computing",
                "courses": [
                    { "name": "Networks and Internet Systems (COMP30040)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Practical: Thurs 14:00-15:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Parallel Computing (COMP30250)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 12:00-12:50, Lecture: Wed 09:00-09:50, Practical: Wed 15:00-16:50" },
                    { "name": "Distributed Systems (COMP41720)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 14:00-15:50" },
                    { "name": "Cloud Computing (COMP47780)", "semester": 1, "credits": 10, "timings": "Lecture: Mon 14:00-15:50, Practical Offering 1: Mon 10:00-11:50, Practical Offering 2: Fri 12:00-13:50" }
                ]
            },
            {
                "theme": "Mathematics and Statistics",
                "courses": [
                    { "name": "Information Theory (COMP30690)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 12:00-13:50, Lecture: Tues 11:00-12:50" },
                    { "name": "Formal Foundations 3 (COMP31020)", "semester": 1, "credits": 5, "timings": "Lecture: Tues 13:00-13:50, Practical: Wed 09:00-10:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Partial Differential Equations (ACM30220)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 13:00-13:50, Lecture: Thurs 11:00-11:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Numerical Algorithms (ACM40290)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 11:00-11:50, Tutorial: Thurs 12:00-12:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Monte Carlo Inference (STAT40400)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 13:00-13:50, Lecture: Wed 15:00-15:50, Tutorial Offering 1: Mon 16:00-16:50, Tutorial Offering 2: Tues 12:00-12:50, Computer Aided Lab Offering 1: Mon 16:00-16:50, Computer Aided Lab Offering 2: Tues 12:00-12:50" },
                    { "name": "Time Series Analysis (STAT40700)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 11:00-11:50, Tutorial: Thurs 17:00-17:50, Tutorial: Tues 17:00-17:50, Lecture: Wed 12:00-12:50, Laboratory Offering 1: Tues 17:00-17:50, Laboratory Offering 2: Wed 17:00-17:50, Laboratory Offering 3: Wed 15:00-15:50" },
                    { "name": "Multivariate Analysis (STAT40150)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Lecture: Wed 16:00-16:50, Computer Aided Lab Offering 1: Mon 16:00-16:50, Computer Aided Lab Offering 2: Mon 14:00-14:50, Computer Aided Lab Offering 3: Thurs 12:00-12:50" }
                ]
            },
            {
                "theme": "Software Engineering",
                "courses": [
                    { "name": "Java Programming (COMP20300)", "semester": 1, "credits": 5, "timings": "Tutorial: Tues 09:00-09:50" },
                    { "name": "Software Engineering (COMP41670)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 13:00-13:50, Lecture: Thurs 15:00-15:50, Computer Aided Lab: Tues 16:00-17:50" },
                    { "name": "Game Development (COMP30540)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 09:00-09:50, Practical: Thurs 14:00-15:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Contemporary Software Development (COMP47480)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 10:00-10:50, Lecture: Mon 12:00-12:50, Laboratory: Tues 11:00-12:50" },
                    { "name": "Advanced Data Structures in Java (online) (COMP47500)", "semester": 2, "credits": 10, "timings": "Lecture: Fri 12:00-13:50, Lecture: Tues 12:00-13:50" }
                ]
            },
            {
                "theme": "Miscellaneous",
                "courses": [
                    { "name": "Information Security (COMP30940)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 09:00-10:50, Tutorial: Thurs 16:00-17:50" },
                    { "name": "Blockchain & Decentralisation (COMP41770)", "semester": 1, "credits": 5, "timings": "Practical: Mon 09:00-10:50, Lecture: Thurs 09:00-10:50" },
                    { "name": "Bioinformatics (COMP40400)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 14:00-14:50" },
                    { "name": "Advanced Information Security (COMP41960)", "semester": 2, "credits": 5, "timings": "Lecture: Tues 09:00-10:50" },
                    { "name": "Leading Teams in the Scientific Enterprise (BMOL30100)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-16:50, Lecture: Tues 15:00-16:50" },
                    { "name": "Technical Communication (MEEN40670)", "semester": 2, "credits": 5, "timings": "Small Group: Fri 11:00-12:50, Lecture: Tues 13:00-13:50" },
                    { "name": "Decision Analytics (MIS30010)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-17:50" }
                ]
            }
        ]
        `;

      // Function to parse the raw data into a structured format
      function parseModules(dataString) {
        const allCourses = [];
        const themes = JSON.parse(dataString.trim());

        themes.forEach((themeObj) => {
          themeObj.courses.forEach((course) => {
            const titleAndCode = course.name;
            const title = titleAndCode.split("(")[0].trim();
            const codeMatch = titleAndCode.match(/\(([^)]+)\)/);
            const code = codeMatch ? codeMatch[1] : "N/A";

            const offerings = course.timings
              .split(",")
              .map((offeringStr, index) => {
                const trimmed = offeringStr.trim();
                const match = trimmed.match(
                  /(.*?):\s*(Mon|Tues|Wed|Thurs|Fri)\s*(\d{2}:\d{2})-(\d{2}:\d{2})/
                );
                if (match) {
                  return {
                    id: `${code}-${index}`,
                    type: match[1].trim(),
                    day: match[2],
                    startTime: match[3],
                    endTime: match[4],
                    raw: trimmed,
                  };
                }
                return null;
              })
              .filter(Boolean);

            if (code !== "N/A") {
              allCourses.push({
                theme: themeObj.theme,
                title: title,
                code: code,
                semester: course.semester,
                credits: course.credits,
                comments: course.comments || "",
                offerings: offerings,
              });
            }
          });
        });
        return allCourses;
      }

      let courses;
      const savedCourses = localStorage.getItem("courses");
      if (savedCourses) {
        courses = JSON.parse(savedCourses);
      } else {
        courses = parseModules(courseDataString);
      }

      let appState = {
        allTimetables: {
          "Default Timetable": [],
        },
        activeTimetableName: "Default Timetable",
        courses: courses,
      };

      const savedState = localStorage.getItem("appState");
      if (savedState) {
        appState = JSON.parse(savedState);
      } else {
        localStorage.setItem("appState", JSON.stringify(appState));
      }

      const courseListContainer = document.getElementById("course-list");
      const searchBar = document.getElementById("search-bar");
      const timingModal = document.getElementById("timing-modal");
      const closeTimingModalBtn = document.getElementById(
        "close-timing-modal-btn"
      );
      const saveTimingBtn = document.getElementById("save-timing-btn");
      const timingForm = document.getElementById("timing-form");
      const courseCodeInput = document.getElementById("course-code-input");
      const totalCreditsSpan = document.getElementById("total-credits");
      const clearAllBtn = document.getElementById("clear-all-btn");
      const timetableGrid = document.getElementById("timetable-grid");
      const timetableEvents = document.getElementById("timetable-events");
      const clashWarning = document.getElementById("clash-warning");
      const addCustomCourseBtn = document.getElementById(
        "add-custom-course-btn"
      );
      const customCourseModal = document.getElementById("custom-course-modal");
      const closeCustomCourseModalBtn = document.getElementById(
        "close-custom-course-modal-btn"
      );
      const saveCustomCourseBtn = document.getElementById(
        "save-custom-course-btn"
      );
      const customTimingsContainer = document.getElementById(
        "custom-timings-container"
      );
      const addAnotherTimingBtn = document.getElementById(
        "add-another-timing-btn"
      );
      const timetableSwitcher = document.getElementById("timetable-switcher");
      const addTimetableBtn = document.getElementById("add-timetable-btn");
      const newTimetableNameInput =
        document.getElementById("new-timetable-name");
      const deleteTimetableBtn = document.getElementById(
        "delete-timetable-btn"
      );

      function saveState() {
        localStorage.setItem("appState", JSON.stringify(appState));
      }

      function render() {
        const searchTerm = searchBar.value.toLowerCase();
        const filteredCourses = appState.courses.filter(
          (course) =>
            course.title.toLowerCase().includes(searchTerm) ||
            course.code.toLowerCase().includes(searchTerm)
        );

        renderCourses(filteredCourses);
        updateTimetableSwitcher();
        updateSummary();
        updateTimetable();
      }

      // Render courses based on the provided list, grouped by theme
      function renderCourses(coursesToRender) {
        courseListContainer.innerHTML = "";

        const groupedByTheme = coursesToRender.reduce((acc, course) => {
          const theme = course.theme;
          if (!acc[theme]) {
            acc[theme] = [];
          }
          acc[theme].push(course);
          return acc;
        }, {});

        if (Object.keys(groupedByTheme).length === 0) {
          courseListContainer.innerHTML =
            '<p class="text-gray-500 text-center">No modules found matching your search.</p>';
          return;
        }

        for (const theme in groupedByTheme) {
          const themeSection = document.createElement("div");
          themeSection.className = "border-b border-gray-200 pb-4";

          const themeButton = document.createElement("button");
          themeButton.className =
            "theme-toggle collapsed w-full flex justify-between items-center text-left text-2xl font-semibold text-gray-800 p-2 rounded-md hover:bg-gray-100";
          themeButton.innerHTML = `
                    <span>${theme}</span>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
          themeSection.appendChild(themeButton);

          const themeGrid = document.createElement("div");
          themeGrid.className =
            "theme-courses-grid hidden grid grid-cols-1 md:grid-cols-2 gap-6 pt-6";

          groupedByTheme[theme].forEach((course) => {
            const card = document.createElement("div");
            card.className =
              "course-card bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col";
            card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-gray-900 mt-1">${
                                  course.title
                                }</h3>
                                <div class="flex space-x-2">
                                    <button class="edit-custom-module-btn p-1 text-gray-400 hover:text-indigo-600" data-course-code="${
                                      course.code
                                    }">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                    </button>
                                    ${
                                      course.theme === "Custom Modules"
                                        ? `
                                    <button class="delete-custom-module-btn p-1 text-gray-400 hover:text-red-600" data-course-code="${course.code}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">${
                              course.code
                            } | Semester ${course.semester || "N/A"} | ${
              course.credits
            } Credits</p>
                            ${
                              course.comments
                                ? `<p class="text-sm text-yellow-600 bg-yellow-50 p-2 rounded-md my-2">${course.comments}</p>`
                                : ""
                            }
                        </div>
                        <div class="mt-4 space-y-2 flex-grow">
                            <p class="font-semibold text-gray-700">Offerings:</p>
                            <div class="offerings-list">
                                ${course.offerings
                                  .map(
                                    (offering) => `
                                    <label class="flex items-center p-3 bg-gray-100 rounded-md hover:bg-gray-200 cursor-pointer">
                                        <input type="checkbox" data-course-code="${course.code}" data-offering-id="${offering.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="ml-3 text-sm text-gray-800">${offering.type}: ${offering.day} ${offering.startTime} - ${offering.endTime}</span>
                                    </label>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="add-timing-btn w-full text-sm text-indigo-600 font-semibold hover:text-indigo-800 p-2 rounded-md border border-indigo-200 hover:bg-indigo-50" data-course-code="${
                              course.code
                            }">Add Timings</button>
                        </div>
                    `;
            themeGrid.appendChild(card);
          });
          themeSection.appendChild(themeGrid);
          courseListContainer.appendChild(themeSection);
        }
      }

      searchBar.addEventListener("input", () => render());

      function showTimingModal(courseCode) {
        timingForm.reset();
        courseCodeInput.value = courseCode;
        timingModal.classList.remove("hidden");
      }

      function hideTimingModal() {
        timingModal.classList.add("hidden");
      }

      closeTimingModalBtn.addEventListener("click", hideTimingModal);
      timingModal.addEventListener("click", (e) => {
        if (e.target === timingModal) {
          hideTimingModal();
        }
      });

      saveTimingBtn.addEventListener("click", () => {
        const courseCode = courseCodeInput.value;
        const type = document.getElementById("offering-type").value;
        const day = document.getElementById("offering-day").value;
        const startTime = document.getElementById("start-time").value;
        const endTime = document.getElementById("end-time").value;

        if (!type || !day || !startTime || !endTime) {
          console.error("All fields are required!");
          return;
        }

        const course = appState.courses.find((c) => c.code === courseCode);
        if (course) {
          const newOffering = {
            id: `${course.code}-${course.offerings.length}`,
            type: type,
            day: day,
            startTime: startTime,
            endTime: endTime,
            raw: `${type}: ${day} ${startTime}-${endTime}`,
          };
          course.offerings.push(newOffering);
          saveState();
          render();
        }
        hideTimingModal();
      });

      courseListContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("add-timing-btn")) {
          const courseCode = e.target.dataset.courseCode;
          showTimingModal(courseCode);
        }
        const button = e.target.closest(".theme-toggle");
        if (button) {
          const grid = button.nextElementSibling;
          const isCollapsed = button.classList.contains("collapsed");

          document.querySelectorAll(".theme-toggle").forEach((otherButton) => {
            if (otherButton !== button) {
              otherButton.classList.add("collapsed");
              otherButton.nextElementSibling.classList.add("hidden");
            }
          });

          if (isCollapsed) {
            grid.classList.remove("hidden");
            button.classList.remove("collapsed");
          } else {
            grid.classList.add("hidden");
            button.classList.add("collapsed");
          }
        }
      });

      courseListContainer.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          const courseCode = e.target.dataset.courseCode;
          const offeringId = e.target.dataset.offeringId;
          const course = appState.courses.find((c) => c.code === courseCode);
          const offering = course.offerings.find((o) => o.id === offeringId);
          const activeTimetable =
            appState.allTimetables[appState.activeTimetableName];

          if (e.target.checked) {
            activeTimetable.push({ ...course, selectedOffering: offering });
          } else {
            const indexToRemove = activeTimetable.findIndex(
              (so) => so.selectedOffering.id === offeringId
            );
            if (indexToRemove > -1) {
              activeTimetable.splice(indexToRemove, 1);
            }
          }
          saveState();
          updateSummary();
          updateTimetable();
        }
      });

      clearAllBtn.addEventListener("click", () => {
        appState.allTimetables[appState.activeTimetableName] = [];
        saveState();
        render();
      });

      function updateSummary() {
        const summaryListContainer = document.getElementById(
          "selected-courses-summary-list"
        );
        const selectedOfferings =
          appState.allTimetables[appState.activeTimetableName] || [];
        const uniqueSelectedCourses = [
          ...new Map(
            selectedOfferings.map((item) => [item["code"], item])
          ).values(),
        ];
        const totalCredits = uniqueSelectedCourses.reduce(
          (sum, course) => sum + course.credits,
          0
        );
        totalCreditsSpan.textContent = totalCredits;

        if (uniqueSelectedCourses.length > 0) {
          summaryListContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mt-4 text-md">Selected Modules:</h3>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 mt-2">
                        ${uniqueSelectedCourses
                          .map(
                            (course) => `
                            <li class="flex justify-between items-center">
                                <span>${course.title}</span>
                                <button class="remove-course-btn text-red-500 hover:text-red-700" data-course-code="${course.code}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </li>
                        `
                          )
                          .join("")}
                    </ul>
                `;
        } else {
          summaryListContainer.innerHTML = "";
        }
      }

      // --- Timetable Logic ---
      const days = ["Mon", "Tues", "Wed", "Thurs", "Fri"];
      const dayToIndex = { Mon: 1, Tues: 2, Wed: 3, Thurs: 4, Fri: 5 };
      const hourHeight = 60;
      const timetableStartHour = 8;

      function createTimetableGrid() {
        timetableGrid.innerHTML = "";
        days.forEach((day, i) => {
          const dayHeader = document.createElement("div");
          dayHeader.className =
            "day-header text-center font-semibold text-sm text-gray-600 border-b border-gray-200 flex items-center justify-center";
          dayHeader.textContent = day;
          dayHeader.style.gridColumn = `${i + 2} / ${i + 3}`;
          timetableGrid.appendChild(dayHeader);
        });

        for (let i = 0; i < 12; i++) {
          const hour = timetableStartHour + i;
          const timeSlot = document.createElement("div");
          timeSlot.className =
            "time-slot text-right pr-2 text-xs text-gray-500";
          timeSlot.textContent = `${hour}:00`;
          timeSlot.style.gridRow = `${i + 2} / ${i + 3}`;
          timetableGrid.appendChild(timeSlot);

          for (let j = 0; j < 5; j++) {
            const gridCell = document.createElement("div");
            gridCell.className = "border-t border-r border-gray-100";
            gridCell.style.gridRow = `${i + 2} / ${i + 3}`;
            gridCell.style.gridColumn = `${j + 2} / ${j + 3}`;
            timetableGrid.appendChild(gridCell);
          }
        }
      }

      function timeToMinutes(time) {
        const [hours, minutes] = time.split(":").map(Number);
        return hours * 60 + minutes;
      }

      function updateTimetable() {
        timetableEvents.innerHTML = "";
        let hasClash = false;
        const eventElements = [];
        const selectedOfferings =
          appState.allTimetables[appState.activeTimetableName] || [];

        selectedOfferings.forEach((offering, index) => {
          const time = offering.selectedOffering;
          const startMinutes = timeToMinutes(time.startTime);
          const endMinutes = timeToMinutes(time.endTime);

          const top =
            (startMinutes / 60 - timetableStartHour) * hourHeight + 40;
          const height = ((endMinutes - startMinutes) / 60) * hourHeight;
          const dayIndex = dayToIndex[time.day];

          const eventEl = document.createElement("div");
          eventEl.className =
            "timetable-event rounded-lg p-2 text-white text-xs overflow-hidden border";
          eventEl.style.top = `${top}px`;
          eventEl.style.height = `${height}px`;

          const dayWidthCalc = "(100% - 60px) / 5";
          eventEl.style.left = `calc(60px + ${
            dayIndex - 1
          } * (${dayWidthCalc}) + 2px)`;
          eventEl.style.width = `calc(${dayWidthCalc} - 4px)`;

          const colorHash = offering.code
            .split("")
            .reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0);
          const color = `hsl(${colorHash % 360}, 50%, 60%)`;
          eventEl.style.backgroundColor = color;
          eventEl.style.borderColor = `hsl(${colorHash % 360}, 50%, 50%)`;

          eventEl.innerHTML = `
                    <p class="font-bold">${offering.title}</p>
                    <p>${time.type}</p>
                    <p>${time.startTime} - ${time.endTime}</p>
                `;

          eventElements.push({ el: eventEl, offering: offering });
        });

        for (let i = 0; i < eventElements.length; i++) {
          for (let j = i + 1; j < eventElements.length; j++) {
            const o1 = eventElements[i].offering.selectedOffering;
            const o2 = eventElements[j].offering.selectedOffering;

            if (o1.day === o2.day) {
              const start1 = timeToMinutes(o1.startTime);
              const end1 = timeToMinutes(o1.endTime);
              const start2 = timeToMinutes(o2.startTime);
              const end2 = timeToMinutes(o2.endTime);

              if (Math.max(start1, start2) < Math.min(end1, end2)) {
                hasClash = true;
                eventElements[i].el.classList.add("clash");
                eventElements[j].el.classList.add("clash");
              }
            }
          }
        }

        clashWarning.classList.toggle("hidden", !hasClash);
        eventElements.forEach((e) => timetableEvents.appendChild(e.el));
      }

      // --- Custom Module Modal Logic ---
      function showCustomCourseModal(courseToEdit = null) {
        const form = document.getElementById("custom-course-form");
        const modalTitle = document.getElementById("custom-course-modal-title");
        const saveButton = document.getElementById("save-custom-course-btn");
        const editingCodeInput = document.getElementById("editing-course-code");

        form.reset();
        customTimingsContainer.innerHTML = "";

        if (courseToEdit) {
          modalTitle.textContent = "Edit Module";
          saveButton.textContent = "Update Module";
          editingCodeInput.value = courseToEdit.code;
          document.getElementById("custom-course-name").value =
            courseToEdit.title;
          document.getElementById("custom-course-code").value =
            courseToEdit.code;
          document.getElementById("custom-course-credits").value =
            courseToEdit.credits;
          document.getElementById("custom-course-semester").value =
            courseToEdit.semester;

          courseToEdit.offerings.forEach((offering) => {
            addTimingField(offering);
          });
        } else {
          modalTitle.textContent = "Add Custom Module";
          saveButton.textContent = "Save Module";
          editingCodeInput.value = "";
          addTimingField();
        }

        customCourseModal.classList.remove("hidden");
      }

      function hideCustomCourseModal() {
        customCourseModal.classList.add("hidden");
      }

      function addTimingField(offering = null) {
        const timingDiv = document.createElement("div");
        timingDiv.className =
          "custom-timing-block p-2 border border-gray-200 rounded-md space-y-2";
        timingDiv.innerHTML = `
                <input type="text" placeholder="Type (e.g., Lecture)" class="w-full p-2 border border-gray-300 rounded-md custom-timing-type" value="${
                  offering ? offering.type : ""
                }" required>
                <select class="w-full p-2 border border-gray-300 rounded-md custom-timing-day" required>
                    <option ${
                      offering && offering.day === "Mon" ? "selected" : ""
                    }>Mon</option>
                    <option ${
                      offering && offering.day === "Tues" ? "selected" : ""
                    }>Tues</option>
                    <option ${
                      offering && offering.day === "Wed" ? "selected" : ""
                    }>Wed</option>
                    <option ${
                      offering && offering.day === "Thurs" ? "selected" : ""
                    }>Thurs</option>
                    <option ${
                      offering && offering.day === "Fri" ? "selected" : ""
                    }>Fri</option>
                </select>
                <div class="flex gap-2">
                    <input type="time" class="w-1/2 p-2 border border-gray-300 rounded-md custom-timing-start" value="${
                      offering ? offering.startTime : ""
                    }" required>
                    <input type="time" class="w-1/2 p-2 border border-gray-300 rounded-md custom-timing-end" value="${
                      offering ? offering.endTime : ""
                    }" required>
                </div>
            `;
        customTimingsContainer.appendChild(timingDiv);
      }

      addCustomCourseBtn.addEventListener("click", () =>
        showCustomCourseModal()
      );
      closeCustomCourseModalBtn.addEventListener(
        "click",
        hideCustomCourseModal
      );
      addAnotherTimingBtn.addEventListener("click", () => addTimingField());

      saveCustomCourseBtn.addEventListener("click", () => {
        const name = document.getElementById("custom-course-name").value;
        const code = document.getElementById("custom-course-code").value;
        const credits = parseFloat(
          document.getElementById("custom-course-credits").value
        );
        const semester = document.getElementById(
          "custom-course-semester"
        ).value;
        const editingCode = document.getElementById(
          "editing-course-code"
        ).value;

        if (!name || !code || !credits) {
          return;
        }

        const offerings = [];
        const timingDivs = customTimingsContainer.querySelectorAll(
          ".custom-timing-block"
        );
        timingDivs.forEach((div, index) => {
          const type = div.querySelector(".custom-timing-type").value;
          const day = div.querySelector(".custom-timing-day").value;
          const startTime = div.querySelector(".custom-timing-start").value;
          const endTime = div.querySelector(".custom-timing-end").value;
          if (type && day && startTime && endTime) {
            offerings.push({
              id: `${code}-${index}`,
              type,
              day,
              startTime,
              endTime,
            });
          }
        });

        if (offerings.length === 0) {
          return;
        }

        if (editingCode) {
          // Editing existing course
          const courseIndex = appState.courses.findIndex(
            (c) => c.code === editingCode
          );
          if (courseIndex > -1) {
            appState.courses[courseIndex] = {
              ...appState.courses[courseIndex],
              title: name,
              code: code,
              credits: credits,
              semester: semester,
              offerings: offerings,
            };
          }
        } else {
          // Adding new course
          const newCourse = {
            theme: "Custom Modules",
            title: name,
            code: code,
            credits: credits,
            offerings: offerings,
            comments: "",
            semester: semester,
          };
          appState.courses.push(newCourse);
        }

        saveState();
        render();
        hideCustomCourseModal();
      });

      function updateTimetableSwitcher() {
        timetableSwitcher.innerHTML = "";
        for (const name in appState.allTimetables) {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (name === appState.activeTimetableName) {
            option.selected = true;
          }
          timetableSwitcher.appendChild(option);
        }
      }

      addTimetableBtn.addEventListener("click", () => {
        const newName = newTimetableNameInput.value.trim();
        if (newName && !appState.allTimetables[newName]) {
          appState.allTimetables[newName] = [];
          appState.activeTimetableName = newName;
          newTimetableNameInput.value = "";
          saveState();
          render();
        }
      });

      timetableSwitcher.addEventListener("change", (e) => {
        appState.activeTimetableName = e.target.value;
        saveState();
        render();
      });

      deleteTimetableBtn.addEventListener("click", () => {
        const currentName = appState.activeTimetableName;
        if (Object.keys(appState.allTimetables).length > 1) {
          delete appState.allTimetables[currentName];
          appState.activeTimetableName = Object.keys(appState.allTimetables)[0];
          saveState();
          render();
        }
      });

      function initializeApp() {
        createTimetableGrid();
        render();
      }

      // --- Event Delegation for dynamic elements ---
      document.body.addEventListener("click", (e) => {
        if (e.target.closest(".remove-course-btn")) {
          const courseCode =
            e.target.closest(".remove-course-btn").dataset.courseCode;
          const activeTimetable =
            appState.allTimetables[appState.activeTimetableName];

          appState.allTimetables[appState.activeTimetableName] =
            activeTimetable.filter((so) => so.code !== courseCode);

          saveState();
          render();
        }

        if (e.target.closest(".edit-custom-module-btn")) {
          const courseCode = e.target.closest(".edit-custom-module-btn").dataset
            .courseCode;
          const courseToEdit = appState.courses.find(
            (c) => c.code === courseCode
          );
          if (courseToEdit) {
            showCustomCourseModal(courseToEdit);
          }
        }

        if (e.target.closest(".delete-custom-module-btn")) {
          const courseCode = e.target.closest(".delete-custom-module-btn")
            .dataset.courseCode;
          appState.courses = appState.courses.filter(
            (c) => c.code !== courseCode
          );

          for (const timetableName in appState.allTimetables) {
            appState.allTimetables[timetableName] = appState.allTimetables[
              timetableName
            ].filter((so) => so.code !== courseCode);
          }

          saveState();
          render();
        }
      });

      // --- Initial Setup ---
      initializeApp();
    </script>
  </body>
</html>
