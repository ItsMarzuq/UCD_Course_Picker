<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .course-card {
        transition: all 0.3s ease;
      }
      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      /* Modal styles */
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .theme-toggle svg {
        transition: transform 0.3s ease;
      }
      .theme-toggle.collapsed svg {
        transform: rotate(-90deg);
      }
      /* Timetable styles */
      #timetable-grid {
        display: grid;
        grid-template-columns: 60px repeat(5, 1fr);
        grid-template-rows: 40px repeat(12, 60px); /* 8am to 8pm */
      }
      .time-slot {
        grid-column: 1 / 2;
      }
      .day-header {
        grid-row: 1 / 2;
      }
      .timetable-event {
        position: absolute;
        z-index: 10;
        transition: all 0.2s ease;
      }
      .timetable-event.clash {
        border: 2px solid #ef4444 !important;
        background-color: rgba(239, 68, 68, 0.2) !important;
        z-index: 20;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">Course Selector</h1>
        <p class="text-lg text-gray-600 mt-2">
          Select course offerings to build your timetable.
        </p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Courses List -->
        <div class="lg:col-span-2">
          <h2 class="text-2xl font-semibold mb-4 text-gray-900">
            Available Courses
          </h2>
          <!-- Search Bar -->
          <div class="mb-6">
            <input
              type="text"
              id="search-bar"
              placeholder="Search by course name or code..."
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div id="course-list" class="space-y-4">
            <!-- Themed course sections will be injected here by JavaScript -->
          </div>
        </div>

        <!-- Sidebar -->
        <div>
          <div class="sticky top-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-900">
                  Selection Summary
                </h2>
                <button
                  id="clear-all-btn"
                  class="text-sm text-red-600 hover:text-red-800 font-semibold"
                >
                  Clear All
                </button>
              </div>
              <div id="selection-summary" class="space-y-2">
                <p class="text-lg">
                  Total Credits:
                  <span id="total-credits" class="font-bold text-indigo-600"
                    >0</span
                  >
                </p>
                <div id="selected-courses-summary-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timetable Section -->
      <div
        id="timetable-container"
        class="bg-white p-4 rounded-lg shadow-md mt-12"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-900 text-center">
          Weekly Timetable
        </h2>
        <div
          id="clash-warning"
          class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"
        >
          <span class="font-bold">Warning:</span> You have timetable clashes.
          Clashing slots are highlighted in red.
        </div>
        <div class="relative">
          <div id="timetable-grid" class="relative bg-white">
            <!-- Grid lines and headers will be generated here -->
          </div>
          <div
            id="timetable-events"
            class="absolute top-0 left-0 w-full h-full"
          >
            <!-- Events will be placed here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add Timings Modal -->
    <div
      id="add-timing-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"
      >
        <div class="mt-3 text-center">
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            Add New Timing
          </h3>
          <div class="mt-2 px-7 py-3">
            <form id="add-timing-form">
              <input type="hidden" id="course-code-input" />
              <div class="mb-4 text-left">
                <label
                  for="offering-type"
                  class="block text-sm font-medium text-gray-700"
                  >Type</label
                >
                <input
                  type="text"
                  id="offering-type"
                  placeholder="e.g., Lecture, Practical"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
              <div class="mb-4 text-left">
                <label
                  for="offering-day"
                  class="block text-sm font-medium text-gray-700"
                  >Day</label
                >
                <select
                  id="offering-day"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                >
                  <option>Mon</option>
                  <option>Tues</option>
                  <option>Wed</option>
                  <option>Thurs</option>
                  <option>Fri</option>
                </select>
              </div>
              <div class="mb-4 text-left">
                <label
                  for="start-time"
                  class="block text-sm font-medium text-gray-700"
                  >Start Time</label
                >
                <input
                  type="time"
                  id="start-time"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
              <div class="mb-4 text-left">
                <label
                  for="end-time"
                  class="block text-sm font-medium text-gray-700"
                  >End Time</label
                >
                <input
                  type="time"
                  id="end-time"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
            </form>
          </div>
          <div class="items-center px-4 py-3">
            <button
              id="save-timing-btn"
              class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300"
            >
              Save
            </button>
            <button
              id="close-modal-btn"
              class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Default course data.
      const courseDataString = `
        [
            {
                "theme": "Artificial Intelligence and Cognitive Science",
                "courses": [
                    { "name": "Human Computer Interaction (COMP30960)", "semester": 1, "credits": 5, "timings": "Practical Offering 1: Fri 13:00-13:50, Lecture: Mon 16:00-16:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Introduction to Cognitive Psychology (COMP40250)", "semester": 1, "credits": 7.5, "timings": "Lecture: Wed 11:00-12:50" },
                    { "name": "Multi-Agent Systems (COMP41400)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 16:00-17:50, Practical: Wed 15:00-16:50" },
                    { "name": "Human-Centred Artificial Intelligence (COMP41740)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Artificial/Human Intelligence (COMP41760)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 11:00-11:50, Practical: Thurs 12:00-12:50" },
                    { "name": "Introduction to Cognitive Science (Graduate) (COMP47230)", "semester": 1, "credits": 7.5, "timings": "Lecture: Mon 11:00-12:50" },
                    { "name": "Connectionism and Dynamical Systems (COMP40260)", "semester": 2, "credits": 7.5, "timings": "Lecture: Mon 11:00-12:50, Practical: Mon 14:00-15:50" },
                    { "name": "Speech and Audio (COMP47700)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 14:00-15:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Generative AI: Language Models (COMP47980)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 16:00-16:50, Practical: Thurs 10:00-11:50, Lecture: Thurs 16:00-16:50" },
                    { "name": "Artificial Intelligence & Ethics (IS40970)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 13:00-14:50" }
                ]
            },
            {
                "theme": "Computer Engineering",
                "courses": [
                    { "name": "Wireless Systems (EEEN40050)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 12:00-12:50, Lecture: Tues 09:00-09:50, Lecture: Wed 14:00-14:50, Laboratory Offering 1: Fri 15:00-16:50, Laboratory Offering 2: Wed 15:00-16:50" },
                    { "name": "Digital Communications (EEEN40060)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 09:00-09:50, Lecture: Thurs 11:00-11:50, Lecture: Thurs 16:00-16:50, Tutorial: Thurs 16:00-17:50, Lecture: Wed 13:00-13:50" },
                    { "name": "Quantitative Methods for Engineers (STAT40690)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 15:00-16:50" },
                    { "name": "Performance of Computer Systems (COMP40010)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Advances in Wireless Networking (COMP40660)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 11:00-12:50, Practical: Mon 13:00-14:50" },
                    { "name": "Digital & Embedded Systems (EEEN40280)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Tutorial: Tues 11:00-12:50, Lecture: Wed 11:00-11:50, Lecture: Wed 13:00-13:50, Laboratory: Thurs 13:00-14:50" }
                ]
            },
            {
                "theme": "Computers and Society",
                "courses": [
                    { "name": "Enterprise, Innovation & Entrepreneurship (COMP30390)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 13:00-13:50, Lecture: Tues 13:00-13:50, Practical: Wed 11:00-12:50" },
                    { "name": "Social Simulation: Methods and Models (SOC40640)", "semester": 1, "credits": 10, "timings": "Lecture: Mon 09:00-09:50, Lecture: Wed 09:00-09:50" },
                    { "name": "Enviro-Tech Boot Camp (COMP30840)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 16:00-16:50, Tutorial: Thurs 13:00-13:50, Lecture: Wed 13:00-13:50" },
                    { "name": "Ethical Hacking (COMP47860)", "semester": 2, "credits": 5, "timings": "Practical Offering 1: Fri 14:00-15:50, Practical Offering 2: Mon 15:00-16:50" },
                    { "name": "Digital Media Ethics (IS30370)", "semester": 2, "credits": 5, "timings": "Lecture: Wed 12:00-13:50" },
                    { "name": "Digital Storytelling (IS30380)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-11:50" },
                    { "name": "Digital Libraries (IS40560)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 16:00-17:50" },
                    { "name": "Social Networks Online and Off (IS41510)", "semester": 2, "credits": 10, "timings": "Lecture: Mon 10:00-11:50" }
                ]
            },
            {
                "theme": "Data Manipulation and Visualisation",
                "courses": [
                    { "name": "Information Visualisation (COMP40610)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 09:00-10:50, Practical Offering 1: Mon 11:00-12:50, Practical Offering 2: Fri 09:00-10:50" },
                    { "name": "Augmented and Virtual Reality (COMP47930)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 13:00-14:50, Practical: Thurs 09:00-10:50" },
                    { "name": "GIS Principles and Applications (GEOG40820)", "semester": 1, "credits": 10, "timings": "Lecture: Wed 15:00-16:50" },
                    { "name": "Spatial Information Systems (COMP30110)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-15:50, Lecture: Thurs 16:00-16:50" },
                    { "name": "Introduction to Relational Databases and SQL Programming (COMP40725)", "semester": 2, "credits": 10, "timings": "Lecture: Fri 09:00-10:50, Practical: Fri 11:00-12:50" },
                    { "name": "Information Visualisation (blended delivery) (COMP47970)", "semester": 2, "credits": 5, "timings": "Laboratory: Fri 14:00-15:50" }
                ]
            },
            {
                "theme": "Prediction and Learning with Data",
                "courses": [
                    { "name": "Data Mining (COMP40370)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 11:00-11:50, Lecture: Tues 13:00-13:50, Practical Offering 1: Tues 16:00-17:50, Practical Offering 2: Wed 13:00-14:50" },
                    { "name": "Connectionist Computing (COMP41390)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Lecture: Wed 10:00-10:50" },
                    { "name": "Text Analytics (COMP41730)", "semester": 1, "credits": 5, "timings": "Lecture: Wed 10:00-10:50" },
                    { "name": "Machine Learning (COMP47460)", "semester": 1, "credits": 5, "timings": "Tutorial: Fri 13:00-14:50" },
                    { "name": "Machine Learning w/ Python (COMP47750)", "semester": "1, 2", "credits": 5, "timings": "Lecture: Thurs 10:00-10:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Optimisation (COMP47790)", "semester": 1, "credits": 5, "timings": "Tutorial: Thurs 14:00-15:50" },
                    { "name": "Intro. to Quantum Computing (EEEN40680)", "semester": 1, "credits": 5, "timings": "Tutorial: Wed 15:00-16:50" },
                    { "name": "Recommender Systems & Collective Intelligence (COMP31010)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 17:00-18:50, Lecture: Wed 14:00-15:50" },
                    { "name": "Advanced Machine Learning (COMP47590)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 12:00-13:50, Laboratory: Tues 15:00-15:50" },
                    { "name": "Deep Learning (COMP47650)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 09:00-10:50, Tutorial: Wed 13:00-13:50" },
                    { "name": "Quantum Machine Learning (COMP47950)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 09:00-10:50" },
                    { "name": "Machine Learning w/ Python (online) (COMP47990)", "semester": 2, "credits": 5, "timings": "Tutorial: Tues 17:00-17:50" },
                    { "name": "Statistical Machine Learning (STAT30270)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Lecture: Wed 15:00-15:50, Tutorial Offering 1: Thurs 17:00-17:50, Tutorial Offering 2: Wed 17:00-17:50, Tutorial Offering 3: Tues 17:00-17:50" }
                ]
            },
            {
                "theme": "Data Science Programming",
                "courses": [
                    { "name": "Data Programming with R (STAT30340)", "semester": 1, "credits": 5, "timings": "Laboratory Offering 1: Thurs 09:00-09:50, Laboratory Offering 2: Thurs 11:00-11:50, Laboratory Offering 3: Mon 09:00-09:50" },
                    { "name": "Data Science in Python (COMP41680)", "semester": 2, "credits": 5, "timings": "Practical: Thurs 09:00-09:50, Lecture: Wed 09:00-09:50" },
                    { "name": "Big Data Programming (COMP47470)", "semester": "1, 2", "credits": 5, "timings": "Practical: Fri 09:00-10:50, Lecture: Tues 09:00-10:50, Practical: Fri 14:00-15:50, Lecture: Tues 11:00-12:50" },
                    { "name": "Data Science in Python (COMP47670)", "semester": "1, 2", "credits": 5, "timings": "Practical: Mon 16:00-16:50, Practical: Mon 17:00-17:50" }
                ]
            },
            {
                "theme": "Distributed Computing",
                "courses": [
                    { "name": "Networks and Internet Systems (COMP30040)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 11:00-11:50, Practical: Thurs 14:00-15:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Parallel Computing (COMP30250)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 12:00-12:50, Lecture: Wed 09:00-09:50, Practical: Wed 15:00-16:50" },
                    { "name": "Distributed Systems (COMP41720)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 14:00-15:50" },
                    { "name": "Cloud Computing (COMP47780)", "semester": 1, "credits": 10, "timings": "Lecture: Mon 14:00-15:50, Practical Offering 1: Mon 10:00-11:50, Practical Offering 2: Fri 12:00-13:50" }
                ]
            },
            {
                "theme": "Mathematics and Statistics",
                "courses": [
                    { "name": "Information Theory (COMP30690)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 12:00-13:50, Lecture: Tues 11:00-12:50" },
                    { "name": "Formal Foundations 3 (COMP31020)", "semester": 1, "credits": 5, "timings": "Lecture: Tues 13:00-13:50, Practical: Wed 09:00-10:50, Lecture: Wed 11:00-11:50" },
                    { "name": "Partial Differential Equations (ACM30220)", "semester": 1, "credits": 5, "timings": "Lecture: Fri 13:00-13:50, Lecture: Thurs 11:00-11:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Numerical Algorithms (ACM40290)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 11:00-11:50, Tutorial: Thurs 12:00-12:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Monte Carlo Inference (STAT40400)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 13:00-13:50, Lecture: Wed 15:00-15:50, Tutorial Offering 1: Mon 16:00-16:50, Tutorial Offering 2: Tues 12:00-12:50, Computer Aided Lab Offering 1: Mon 16:00-16:50, Computer Aided Lab Offering 2: Tues 12:00-12:50" },
                    { "name": "Time Series Analysis (STAT40700)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 11:00-11:50, Tutorial: Thurs 17:00-17:50, Tutorial: Tues 17:00-17:50, Lecture: Wed 12:00-12:50, Laboratory Offering 1: Tues 17:00-17:50, Laboratory Offering 2: Wed 17:00-17:50, Laboratory Offering 3: Wed 15:00-15:50" },
                    { "name": "Multivariate Analysis (STAT40150)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 10:00-10:50, Lecture: Wed 16:00-16:50, Computer Aided Lab Offering 1: Mon 16:00-16:50, Computer Aided Lab Offering 2: Mon 14:00-14:50, Computer Aided Lab Offering 3: Thurs 12:00-12:50" }
                ]
            },
            {
                "theme": "Software Engineering",
                "courses": [
                    { "name": "Java Programming (COMP20300)", "semester": 1, "credits": 5, "timings": "Tutorial: Tues 09:00-09:50" },
                    { "name": "Software Engineering (COMP41670)", "semester": 1, "credits": 5, "timings": "Lecture: Mon 13:00-13:50, Lecture: Thurs 15:00-15:50, Computer Aided Lab: Tues 16:00-17:50" },
                    { "name": "Game Development (COMP30540)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 09:00-09:50, Practical: Thurs 14:00-15:50, Lecture: Wed 12:00-12:50" },
                    { "name": "Contemporary Software Development (COMP47480)", "semester": 2, "credits": 5, "timings": "Lecture: Fri 10:00-10:50, Lecture: Mon 12:00-12:50, Laboratory: Tues 11:00-12:50" },
                    { "name": "Advanced Data Structures in Java (online) (COMP47500)", "semester": 2, "credits": 10, "timings": "Lecture: Fri 12:00-13:50, Lecture: Tues 12:00-13:50" }
                ]
            },
            {
                "theme": "Miscellaneous",
                "courses": [
                    { "name": "Information Security (COMP30940)", "semester": 1, "credits": 5, "timings": "Lecture: Thurs 09:00-10:50, Tutorial: Thurs 16:00-17:50" },
                    { "name": "Blockchain & Decentralisation (COMP41770)", "semester": 1, "credits": 5, "timings": "Practical: Mon 09:00-10:50, Lecture: Thurs 09:00-10:50" },
                    { "name": "Bioinformatics (COMP40400)", "semester": 2, "credits": 5, "timings": "Lecture: Thurs 14:00-14:50" },
                    { "name": "Advanced Information Security (COMP41960)", "semester": 2, "credits": 5, "timings": "Lecture: Tues 09:00-10:50" },
                    { "name": "Leading Teams in the Scientific Enterprise (BMOL30100)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-16:50, Lecture: Tues 15:00-16:50" },
                    { "name": "Technical Communication (MEEN40670)", "semester": 2, "credits": 5, "timings": "Small Group: Fri 11:00-12:50, Lecture: Tues 13:00-13:50" },
                    { "name": "Decision Analytics (MIS30010)", "semester": 2, "credits": 5, "timings": "Lecture: Mon 15:00-17:50" }
                ]
            }
        ]
        `;

      // Function to parse the raw data into a structured format
      function parseCourses(dataString) {
        const allCourses = [];
        const themes = JSON.parse(dataString.trim());

        themes.forEach((themeObj) => {
          themeObj.courses.forEach((course) => {
            const titleAndCode = course.name;
            const title = titleAndCode.split("(")[0].trim();
            const codeMatch = titleAndCode.match(/\(([^)]+)\)/);
            const code = codeMatch ? codeMatch[1] : "N/A";

            const offerings = course.timings
              .split(",")
              .map((offeringStr, index) => {
                const trimmed = offeringStr.trim();
                const match = trimmed.match(
                  /(.*?):\s*(Mon|Tues|Wed|Thurs|Fri)\s*(\d{2}:\d{2})-(\d{2}:\d{2})/
                );
                if (match) {
                  return {
                    id: `${code}-${index}`,
                    type: match[1].trim(),
                    day: match[2],
                    startTime: match[3],
                    endTime: match[4],
                    raw: trimmed,
                  };
                }
                return null;
              })
              .filter(Boolean);

            if (code !== "N/A" && offerings.length > 0) {
              allCourses.push({
                theme: themeObj.theme,
                title: title,
                code: code,
                semester: course.semester,
                credits: course.credits,
                comments: course.comments || "",
                offerings: offerings,
              });
            }
          });
        });
        return allCourses;
      }

      let courses;
      const savedCourses = localStorage.getItem("courses");
      if (savedCourses) {
        courses = JSON.parse(savedCourses);
      } else {
        courses = parseCourses(courseDataString);
      }

      let selectedOfferings =
        JSON.parse(localStorage.getItem("selectedOfferings")) || [];

      const courseListContainer = document.getElementById("course-list");
      const searchBar = document.getElementById("search-bar");
      const modal = document.getElementById("add-timing-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");
      const saveTimingBtn = document.getElementById("save-timing-btn");
      const addTimingForm = document.getElementById("add-timing-form");
      const courseCodeInput = document.getElementById("course-code-input");
      const totalCreditsSpan = document.getElementById("total-credits");
      const clearAllBtn = document.getElementById("clear-all-btn");
      const timetableGrid = document.getElementById("timetable-grid");
      const timetableEvents = document.getElementById("timetable-events");
      const clashWarning = document.getElementById("clash-warning");

      // Render courses based on the provided list, grouped by theme
      function renderCourses(coursesToRender) {
        courseListContainer.innerHTML = "";

        const groupedByTheme = coursesToRender.reduce((acc, course) => {
          const theme = course.theme;
          if (!acc[theme]) {
            acc[theme] = [];
          }
          acc[theme].push(course);
          return acc;
        }, {});

        if (Object.keys(groupedByTheme).length === 0) {
          courseListContainer.innerHTML =
            '<p class="text-gray-500 text-center">No courses found matching your search.</p>';
          return;
        }

        for (const theme in groupedByTheme) {
          const themeSection = document.createElement("div");
          themeSection.className = "border-b border-gray-200 pb-4";

          const themeButton = document.createElement("button");
          themeButton.className =
            "theme-toggle collapsed w-full flex justify-between items-center text-left text-2xl font-semibold text-gray-800 p-2 rounded-md hover:bg-gray-100";
          themeButton.innerHTML = `
                    <span>${theme}</span>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
          themeSection.appendChild(themeButton);

          const themeGrid = document.createElement("div");
          themeGrid.className =
            "theme-courses-grid hidden grid grid-cols-1 md:grid-cols-2 gap-6 pt-6";

          groupedByTheme[theme].forEach((course) => {
            const card = document.createElement("div");
            card.className =
              "course-card bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col";
            card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mt-1">${
                              course.title
                            }</h3>
                            <p class="text-sm text-gray-500 mb-2">${
                              course.code
                            } | Semester ${course.semester} | ${
              course.credits
            } Credits</p>
                            ${
                              course.comments
                                ? `<p class="text-sm text-yellow-600 bg-yellow-50 p-2 rounded-md my-2">${course.comments}</p>`
                                : ""
                            }
                        </div>
                        <div class="mt-4 space-y-2 flex-grow">
                            <p class="font-semibold text-gray-700">Offerings:</p>
                            <div class="offerings-list">
                                ${course.offerings
                                  .map(
                                    (offering) => `
                                    <label class="flex items-center p-3 bg-gray-100 rounded-md hover:bg-gray-200 cursor-pointer">
                                        <input type="checkbox" data-course-code="${course.code}" data-offering-id="${offering.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="ml-3 text-sm text-gray-800">${offering.type}: ${offering.day} ${offering.startTime} - ${offering.endTime}</span>
                                    </label>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="add-timing-btn w-full text-sm text-indigo-600 font-semibold hover:text-indigo-800 p-2 rounded-md border border-indigo-200 hover:bg-indigo-50" data-course-code="${
                              course.code
                            }">Add Timings</button>
                        </div>
                    `;
            themeGrid.appendChild(card);
          });
          themeSection.appendChild(themeGrid);
          courseListContainer.appendChild(themeSection);
        }
      }

      searchBar.addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredCourses = courses.filter(
          (course) =>
            course.title.toLowerCase().includes(searchTerm) ||
            course.code.toLowerCase().includes(searchTerm)
        );
        renderCourses(filteredCourses);
      });

      function showModal(courseCode) {
        addTimingForm.reset();
        courseCodeInput.value = courseCode;
        modal.classList.remove("hidden");
      }

      function hideModal() {
        modal.classList.add("hidden");
      }

      closeModalBtn.addEventListener("click", hideModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          hideModal();
        }
      });

      saveTimingBtn.addEventListener("click", () => {
        const courseCode = courseCodeInput.value;
        const type = document.getElementById("offering-type").value;
        const day = document.getElementById("offering-day").value;
        const startTime = document.getElementById("start-time").value;
        const endTime = document.getElementById("end-time").value;

        if (!type || !day || !startTime || !endTime) {
          console.error("All fields are required!");
          return;
        }

        const course = courses.find((c) => c.code === courseCode);
        if (course) {
          const newOffering = {
            id: `${course.code}-${course.offerings.length}`,
            type: type,
            day: day,
            startTime: startTime,
            endTime: endTime,
            raw: `${type}: ${day} ${startTime}-${endTime}`,
          };
          course.offerings.push(newOffering);
          localStorage.setItem("courses", JSON.stringify(courses));
          const searchTerm = searchBar.value.toLowerCase();
          const filteredCourses = courses.filter(
            (c) =>
              c.title.toLowerCase().includes(searchTerm) ||
              c.code.toLowerCase().includes(searchTerm)
          );
          renderCourses(filteredCourses);
        }
        hideModal();
      });

      courseListContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("add-timing-btn")) {
          const courseCode = e.target.dataset.courseCode;
          showModal(courseCode);
        }
        const button = e.target.closest(".theme-toggle");
        if (button) {
          const grid = button.nextElementSibling;
          const isCollapsed = button.classList.contains("collapsed");

          // Close all other sections
          document.querySelectorAll(".theme-toggle").forEach((otherButton) => {
            if (otherButton !== button) {
              otherButton.classList.add("collapsed");
              otherButton.nextElementSibling.classList.add("hidden");
            }
          });

          // Toggle the clicked section
          if (isCollapsed) {
            grid.classList.remove("hidden");
            button.classList.remove("collapsed");
          } else {
            grid.classList.add("hidden");
            button.classList.add("collapsed");
          }
        }
      });

      courseListContainer.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          const courseCode = e.target.dataset.courseCode;
          const offeringId = e.target.dataset.offeringId;
          const course = courses.find((c) => c.code === courseCode);
          const offering = course.offerings.find((o) => o.id === offeringId);

          if (e.target.checked) {
            selectedOfferings.push({ ...course, selectedOffering: offering });
          } else {
            selectedOfferings = selectedOfferings.filter(
              (so) => so.selectedOffering.id !== offeringId
            );
          }
          localStorage.setItem(
            "selectedOfferings",
            JSON.stringify(selectedOfferings)
          );
          updateSummary();
          updateTimetable();
        }
      });

      clearAllBtn.addEventListener("click", () => {
        selectedOfferings = [];
        localStorage.setItem(
          "selectedOfferings",
          JSON.stringify(selectedOfferings)
        );
        document
          .querySelectorAll('input[type="checkbox"]')
          .forEach((checkbox) => (checkbox.checked = false));
        updateSummary();
        updateTimetable();
      });

      function updateSummary() {
        const summaryListContainer = document.getElementById(
          "selected-courses-summary-list"
        );
        const uniqueSelectedCourses = [
          ...new Map(
            selectedOfferings.map((item) => [item["code"], item])
          ).values(),
        ];
        const totalCredits = uniqueSelectedCourses.reduce(
          (sum, course) => sum + course.credits,
          0
        );
        totalCreditsSpan.textContent = totalCredits;

        if (uniqueSelectedCourses.length > 0) {
          summaryListContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mt-4 text-md">Selected Courses:</h3>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 mt-2">
                        ${uniqueSelectedCourses
                          .map((course) => `<li>${course.title}</li>`)
                          .join("")}
                    </ul>
                `;
        } else {
          summaryListContainer.innerHTML = "";
        }
      }

      // --- Timetable Logic ---
      const days = ["Mon", "Tues", "Wed", "Thurs", "Fri"];
      const dayToIndex = { Mon: 1, Tues: 2, Wed: 3, Thurs: 4, Fri: 5 };
      const hourHeight = 60; // Corresponds to grid-template-rows height
      const timetableStartHour = 8;

      function createTimetableGrid() {
        timetableGrid.innerHTML = "";
        // Create Day Headers
        days.forEach((day, i) => {
          const dayHeader = document.createElement("div");
          dayHeader.className =
            "day-header text-center font-semibold text-sm text-gray-600 border-b border-gray-200 flex items-center justify-center";
          dayHeader.textContent = day;
          dayHeader.style.gridColumn = `${i + 2} / ${i + 3}`;
          timetableGrid.appendChild(dayHeader);
        });

        // Create Time Slots and Grid Lines
        for (let i = 0; i < 12; i++) {
          // 8am to 7pm
          const hour = timetableStartHour + i;
          const timeSlot = document.createElement("div");
          timeSlot.className =
            "time-slot text-right pr-2 text-xs text-gray-500";
          timeSlot.textContent = `${hour}:00`;
          timeSlot.style.gridRow = `${i + 2} / ${i + 3}`;
          timetableGrid.appendChild(timeSlot);

          for (let j = 0; j < 5; j++) {
            const gridCell = document.createElement("div");
            gridCell.className = "border-t border-r border-gray-100";
            gridCell.style.gridRow = `${i + 2} / ${i + 3}`;
            gridCell.style.gridColumn = `${j + 2} / ${j + 3}`;
            timetableGrid.appendChild(gridCell);
          }
        }
      }

      function timeToMinutes(time) {
        const [hours, minutes] = time.split(":").map(Number);
        return hours * 60 + minutes;
      }

      function updateTimetable() {
        timetableEvents.innerHTML = "";
        let hasClash = false;
        const eventElements = [];

        selectedOfferings.forEach((offering, index) => {
          const time = offering.selectedOffering;
          const startMinutes = timeToMinutes(time.startTime);
          const endMinutes = timeToMinutes(time.endTime);

          const top =
            (startMinutes / 60 - timetableStartHour) * hourHeight + 40; // +40 for header
          const height = ((endMinutes - startMinutes) / 60) * hourHeight;
          const dayIndex = dayToIndex[time.day];

          const eventEl = document.createElement("div");
          eventEl.className =
            "timetable-event rounded-lg p-2 text-white text-xs overflow-hidden border";
          eventEl.style.top = `${top}px`;
          eventEl.style.height = `${height}px`;

          const dayWidthCalc = "(100% - 60px) / 5";
          eventEl.style.left = `calc(60px + ${
            dayIndex - 1
          } * (${dayWidthCalc}) + 2px)`;
          eventEl.style.width = `calc(${dayWidthCalc} - 4px)`;

          // Simple hash for color
          const colorHash = offering.code
            .split("")
            .reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0);
          const color = `hsl(${colorHash % 360}, 50%, 60%)`;
          eventEl.style.backgroundColor = color;
          eventEl.style.borderColor = `hsl(${colorHash % 360}, 50%, 50%)`;

          eventEl.innerHTML = `
                    <p class="font-bold">${offering.title}</p>
                    <p>${time.type}</p>
                    <p>${time.startTime} - ${time.endTime}</p>
                `;

          eventElements.push({ el: eventEl, offering: offering });
        });

        // Clash detection
        for (let i = 0; i < eventElements.length; i++) {
          for (let j = i + 1; j < eventElements.length; j++) {
            const o1 = eventElements[i].offering.selectedOffering;
            const o2 = eventElements[j].offering.selectedOffering;

            if (o1.day === o2.day) {
              const start1 = timeToMinutes(o1.startTime);
              const end1 = timeToMinutes(o1.endTime);
              const start2 = timeToMinutes(o2.startTime);
              const end2 = timeToMinutes(o2.endTime);

              if (Math.max(start1, start2) < Math.min(end1, end2)) {
                hasClash = true;
                eventElements[i].el.classList.add("clash");
                eventElements[j].el.classList.add("clash");
              }
            }
          }
        }

        clashWarning.classList.toggle("hidden", !hasClash);
        eventElements.forEach((e) => timetableEvents.appendChild(e.el));
      }

      function initializeApp() {
        renderCourses(courses);
        createTimetableGrid();

        // Restore checkbox state from localStorage
        document
          .querySelectorAll('input[type="checkbox"]')
          .forEach((checkbox) => {
            const offeringId = checkbox.dataset.offeringId;
            if (
              selectedOfferings.some(
                (so) => so.selectedOffering.id === offeringId
              )
            ) {
              checkbox.checked = true;
            }
          });

        updateSummary();
        updateTimetable();
      }

      // --- Initial Setup ---
      initializeApp();
    </script>
  </body>
</html>
